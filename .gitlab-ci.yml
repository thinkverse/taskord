include:
  - template: Dependency-Scanning.gitlab-ci.yml
  - template: License-Scanning.gitlab-ci.yml
  - template: SAST.gitlab-ci.yml
  - template: Secret-Detection.gitlab-ci.yml
  - template: Accessibility.gitlab-ci.yml
  - template: DAST.gitlab-ci.yml
  - template: Code-Quality.gitlab-ci.yml
  - template: Coverage-Fuzzing.gitlab-ci.yml
  - template: Jobs/Browser-Performance-Testing.gitlab-ci.yml

services:
  - mysql:latest

performance:
  variables:
    URL: "https://stg.taskord.com"

variables:
  MYSQL_ROOT_PASSWORD: root
  MYSQL_USER: taskord
  MYSQL_PASSWORD: taskord
  MYSQL_DATABASE: taskord
  DB_HOST: mysql
  a11y_urls: "https://stg.taskord.com"
  DAST_WEBSITE: "https://stg.taskord.com"
  SAST_EXCLUDED_PATHS: node_modules, vendor

stages:
  - deploy
  - test
  - dast
  - accessibility
  - performance

cache:
  paths:
    - vendor/
    - node_modules/

Test:
  image: taskord/php:7.4
  stage: test
  script:
    - sudo composer install
    - cp .env.ci .env
    - php artisan key:generate
    - sudo npm install
    - npm run production
    - php artisan migrate:fresh --seed
    - php artisan test
  allow_failure: true

Housekeeping:
  stage: deploy
  script:
    - curl --request POST --header "PRIVATE-TOKEN:$ACCESS_TOKEN" https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/housekeeping
  only:
    - main

Merged Branches:
  stage: deploy
  script:
    - curl --request DELETE --header "PRIVATE-TOKEN:$ACCESS_TOKEN" https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/repository/merged_branches
  only:
    - main

Deploy Production:
  stage: deploy
  environment: 
    name: Production
    url: "https://taskord.com"
  script:
    - echo $PRIVATE_KEY
    - echo $PRIVATE_KEY > taskord.pem
    - chmod 400 taskord.pem
    - ssh -o StrictHostKeyChecking=no -i "taskord.pem" ubuntu@deploy.taskord.com 'ls'
