image: edbizarro/gitlab-ci-pipeline-php:7.4

services:
  - mysql:5.7

variables:
  MYSQL_ROOT_PASSWORD: root
  MYSQL_USER: taskord
  MYSQL_PASSWORD: taskord
  MYSQL_DATABASE: taskord
  DB_HOST: mysql

stages:
  - test
  - deploy

cache:
  paths:
    - vendor/
    - node_modules/

Test:
  stage: test
  script:
    - sudo composer install
    - cp .env.ci .env
    - php artisan key:generate
    - sudo npm install
    - npm run production
    - php artisan migrate:fresh --seed
    - php artisan test

Housekeeping:
  stage: deploy
  script:
    - curl --request POST --header "PRIVATE-TOKEN:$ACCESS_TOKEN" https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/housekeeping

Merged Branches:
  stage: deploy
  script:
    - curl --request DELETE --header "PRIVATE-TOKEN:$ACCESS_TOKEN" https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/repository/merged_branches
