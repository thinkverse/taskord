services:
  - mysql:latest

variables:
  MYSQL_ROOT_PASSWORD: root
  MYSQL_USER: taskord
  MYSQL_PASSWORD: taskord
  MYSQL_DATABASE: taskord
  DB_HOST: mysql

stages:
  - test
  - clean

cache:
  paths:
    - vendor/
    - node_modules/

Test:
  image: edbizarro/gitlab-ci-pipeline-php:latest
  stage: test
  script:
    - sudo composer self-update --2
    - sudo composer install --no-progress --ignore-platform-reqs
    - cp .env.ci .env
    - php artisan key:generate
    - sudo npm i -g yarn
    - sudo yarn install
    - sudo yarn production
    - php artisan horizon:install
    - php artisan horizon:publish
    - php artisan migrate:fresh --seed
    - php artisan test

Enlightn:
  image: edbizarro/gitlab-ci-pipeline-php:latest
  stage: test
  script:
    - sudo composer self-update --2
    - sudo composer install --no-progress --ignore-platform-reqs
    - cp .env.ci .env
    - php artisan key:generate
    - php artisan enlightn
  allow_failure: true

Commands:
  image: edbizarro/gitlab-ci-pipeline-php:latest
  stage: test
  script:
    - sudo composer self-update --2
    - sudo composer install --no-progress --ignore-platform-reqs
    - cp .env.ci .env
    - php artisan key:generate
    - php artisan migrate:fresh --seed
    - php artisan user:streaks
    - php artisan user:streaks all
    - php artisan user:reset-goal

Docker Compose:
  image: edbizarro/gitlab-ci-pipeline-php:latest
  stage: test
  script:
    - sudo composer self-update --2
    - sudo composer install --no-progress --ignore-platform-reqs
    - cp .env.example .env
    - sudo apt update -yqq
    - sudo apt install apt-transport-https ca-certificates curl software-properties-common
    - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
    - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"
    - sudo apt update -yqq
    - sudo apt install docker-ce -yqq
    - ./vendor/bin/sail up -d

Housekeeping:
  stage: clean
  script:
    - curl --request POST --header "PRIVATE-TOKEN:$ACCESS_TOKEN" https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/housekeeping
  only:
    - main

Merged Branches:
  stage: clean
  script:
    - curl --request DELETE --header "PRIVATE-TOKEN:$ACCESS_TOKEN" https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/repository/merged_branches
  only:
    - main
